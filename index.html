<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Guild Analytics</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ink: {
              50:'#f7f7fb',100:'#efeff7',200:'#e3e3ee',300:'#cfcfe0',
              400:'#a9a9c2',500:'#7d7da1',600:'#595982',700:'#424266',
              800:'#2e2e4c',900:'#24243d'
            }
          }
        }
      }
    };
  </script>

  <!-- Chart.js + date adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

  <style>
    .card{box-shadow:0 10px 30px rgba(0,0,0,.08)}
    .glass{backdrop-filter:blur(10px);background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03))}
    .dark .glass{background:linear-gradient(180deg,rgba(30,30,46,.8),rgba(30,30,46,.6))}
    .chart-wrap{height:320px}
    .mono{font-variant-numeric:tabular-nums}

    .navbtn {
      padding: 6px 10px;
      border-radius: 6px;
      opacity: 0.8;
    }
    .navbtn.active {
      background: rgba(255,255,255,0.12);
      opacity: 1;
    }
  </style>
</head>

<body class="bg-ink-900 text-white">

  <!-- NAVBAR -->
  <nav class="bg-ink-800 text-white px-4 py-3 flex gap-4 text-sm font-semibold sticky top-0 z-50">
    <button data-view="raids" class="navbtn active">Raid Analysis</button>
    <button data-view="helper" class="navbtn">Raid JSON Helper</button>
  </nav>

  <!-- RAID ANALYZER VIEW -->
  <section id="view-raids">
    <div class="max-w-7xl mx-auto px-4 py-8">
      <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-8">
        <div>
          <h1 class="text-3xl md:text-4xl font-bold">Raid Performance Analyzer</h1>
          <p class="text-ink-300">
            Data is loaded from <span class="font-semibold">data/raids.json</span> and visualized for officer review.
          </p>
        </div>

        <div class="flex items-center gap-2">
          <a
            href="https://swgoh.gg/g/iGfoy85uQMywECHWLq5FpQ/raid-history/"
            target="_blank"
            rel="noopener"
            class="px-3 py-2 rounded-xl bg-ink-700 hover:bg-ink-600 text-white text-sm font-semibold"
          >
            Open Guild on SWGOH.GG
          </a>

          <button
            id="downloadPng"
            class="hidden md:inline px-3 py-2 rounded-xl bg-ink-800 text-white opacity-80 hover:opacity-100 text-sm"
          >
            Download Charts (PNG)
          </button>
        </div>
      </header>

      <!-- Summary KPIs -->
      <section id="summary" class="grid md:grid-cols-4 gap-4 mb-8">
        <div id="summary-loading" class="card glass rounded-2xl p-4 md:p-6 col-span-full text-ink-300 text-sm">
          Loading raid data…
        </div>
      </section>

      <!-- Charts + table -->
      <section class="grid lg:grid-cols-2 gap-6">
        <div class="card glass rounded-2xl p-4 md:p-6">
          <h2 class="text-xl font-semibold">Participation Trend</h2>
          <div class="text-sm text-ink-300 mb-3">Number of raiders per run</div>
          <div class="chart-wrap"><canvas id="chartParticipants"></canvas></div>
        </div>

        <div class="card glass rounded-2xl p-4 md:p-6">
          <h2 class="text-xl font-semibold">Total Points</h2>
          <div class="text-sm text-ink-300 mb-3">Overall points per raid</div>
          <div class="chart-wrap"><canvas id="chartPoints"></canvas></div>
        </div>

        <div class="card glass rounded-2xl p-4 md:p-6">
          <h2 class="text-xl font-semibold">Points per Participant</h2>
          <div class="text-sm text-ink-300 mb-3">Efficiency</div>
          <div class="chart-wrap"><canvas id="chartRatio"></canvas></div>
        </div>

        <div class="card glass rounded-2xl p-4 md:p-6">
          <h2 class="text-xl font-semibold">Time Between Raids (days)</h2>
          <div class="text-sm text-ink-300 mb-3">Cadence</div>
          <div class="chart-wrap"><canvas id="chartGaps"></canvas></div>
        </div>

        <div class="card glass rounded-2xl p-4 md:p-6 lg:col-span-2">
          <h2 class="text-xl font-semibold">Parsed Raids</h2>
          <div class="overflow-x-auto mt-3">
            <table class="min-w-full text-sm">
              <thead>
                <tr class="text-left border-b border-ink-700">
                  <th class="py-2 pr-4">Date</th>
                  <th class="py-2 pr-4">Participants</th>
                  <th class="py-2 pr-4">Points</th>
                  <th class="py-2 pr-4">Pts / Part.</th>
                  <th class="py-2 pr-4">Days since prev.</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </section>

  <!-- RAID JSON HELPER VIEW -->
  <section id="view-helper" class="hidden">
    <div class="max-w-4xl mx-auto px-4 py-8">
      <h2 class="text-2xl font-bold mb-4">Raid JSON Helper</h2>
      <p class="text-ink-300 mb-4 text-sm">
        Paste raid rows below (same format you copy from SWGOH.GG: each line ending with
        <span class="mono">POINTS PARTICIPANTS YYYY-MM-DD</span>). This tool converts them into
        the JSON format used by <code>data/raids.json</code>.
      </p>

      <textarea id="helper-raw"
        class="w-full h-48 rounded-xl bg-ink-800 border border-ink-600 p-3 mono"
        placeholder="Example:
win Order 66 19.8M 29 2025-11-21
win Order 66 18.2M 27 2025-11-12
..."></textarea>

      <button id="helper-convert"
        class="mt-4 px-4 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-semibold">
        Convert to JSON
      </button>

      <h3 class="text-xl font-semibold mt-6 mb-2">Output</h3>
      <p class="text-ink-300 mb-2 text-xs">
        Copy the <code>"raids": [...]</code> block (or entire object) into <code>data/raids.json</code> in the repo.
      </p>
      <pre id="helper-out"
        class="bg-ink-900 border border-ink-700 p-4 rounded-xl text-xs overflow-auto mono"></pre>
    </div>
  </section>

  <script>
    function $(sel){ return document.querySelector(sel); }

    var ctx = { participants:null, points:null, ratio:null, gaps:null };

    function parseNumberWithSuffix(val){
      if (typeof val !== 'string') return Number(val) || 0;
      var cleaned = val.replace(/,/g,'').trim();
      var m = cleaned.match(/^([\d.]+)\s*([KMB]?)$/i);
      if (!m) return Number(cleaned) || 0;
      var num = parseFloat(m[1]);
      var suf = (m[2]||'').toUpperCase();
      var mult = (suf==='B')?1e9:(suf==='M')?1e6:(suf==='K')?1e3:1;
      return num*mult;
    }

    function formatCompact(n){
      if (!isFinite(n)) return '-';
      var a = Math.abs(n);
      if (a>=1e9) return (n/1e9).toFixed(2).replace(/\.00$/,'')+'B';
      if (a>=1e6) return (n/1e6).toFixed(2).replace(/\.00$/,'')+'M';
      if (a>=1e3) return (n/1e3).toFixed(2).replace(/\.00$/,'')+'K';
      return String(Math.round(n));
    }

    function kpiCard(title,value,sub){
      var div = document.createElement('div');
      div.className='card glass rounded-2xl p-4 md:p-6 flex flex-col gap-1';
      div.innerHTML =
        '<div class="text-sm text-ink-300">'+title+'</div>'+
        '<div class="text-2xl font-bold mono">'+value+'</div>'+
        (sub?'<div class="text-xs text-ink-400">'+sub+'</div>':'');
      return div;
    }

    function renderSummary(rows){
      var wrap = $('#summary');
      wrap.innerHTML='';
      if (!rows.length) return;
      var last = rows[rows.length-1];
      var total = rows.reduce(function(a,r){return a+r.points;},0);
      var avgP = rows.reduce(function(a,r){return a+r.participants;},0)/rows.length;
      var gaps = rows.map(function(r){return r.gapDays;}).filter(function(v){return typeof v==='number';});
      var lastGap = gaps.length? gaps[gaps.length-1]: null;
      var prevGap = gaps.length>1? gaps[gaps.length-2]: null;
      var gapDelta = (lastGap!=null && prevGap!=null)? lastGap - prevGap : null;
      var faster = gapDelta==null? '' : (gapDelta<0? 'faster' : (gapDelta>0? 'slower':'same'));

      wrap.appendChild(kpiCard(
        'Most Recent Raid',
        last.date.toISOString().slice(0,10),
        last.participants+' participants · '+formatCompact(last.points)+' pts'
      ));
      wrap.appendChild(kpiCard('Total Points (all runs)', formatCompact(total), ''));
      wrap.appendChild(kpiCard(
        'Avg Participants',
        String(Math.round(avgP)),
        'Range '+Math.min.apply(null, rows.map(function(r){return r.participants;}))+'–'+
        Math.max.apply(null, rows.map(function(r){return r.participants;}))
      ));
      wrap.appendChild(kpiCard(
        'Cadence (last gap)',
        lastGap==null?'—':(lastGap+' days'),
        gapDelta==null? '' : (Math.abs(gapDelta)+' '+faster+' than prior')
      ));
    }

    function destroyChartIfExists(c){ if (c && typeof c.destroy==='function') c.destroy(); }

    function makeLineChart(canvasId,labels,dataset,label,fmt){
      var el = document.getElementById(canvasId);
      return new Chart(el,{
        type:'line',
        data:{
          labels:labels,
          datasets:[{
            label:label,
            data:dataset,
            tension:0.35,
            borderWidth:2,
            pointRadius:3,
            pointHoverRadius:5
          }]
        },
        options:{
          maintainAspectRatio:false,
          parsing:false,
          scales:{
            x:{type:'time',time:{unit:'day'},grid:{display:false}},
            y:{
              ticks:{callback:function(v){return fmt?fmt(v):v;}},
              beginAtZero:true
            }
          },
          plugins:{
            legend:{display:false},
            tooltip:{
              callbacks:{
                label:function(c){
                  var v=c.parsed.y;
                  return label+': '+(fmt?fmt(v):v);
                }
              }
            }
          }
        }
      });
    }

    function renderTable(rows){
      var tbody = document.getElementById('tbody');
      tbody.innerHTML='';
      rows.forEach(function(r){
        var tr = document.createElement('tr');
        tr.className='border-b border-ink-800';
        tr.innerHTML =
          '<td class="py-2 pr-4 mono">'+r.date.toISOString().slice(0,10)+'</td>'+
          '<td class="py-2 pr-4 mono">'+r.participants+'</td>'+
          '<td class="py-2 pr-4 mono">'+formatCompact(r.points)+'</td>'+
          '<td class="py-2 pr-4 mono">'+formatCompact(r.ratio)+'</td>'+
          '<td class="py-2 pr-4 mono">'+(r.gapDays==null?'—':r.gapDays)+'</td>';
        tbody.appendChild(tr);
      });
    }

    function setupDownload(){
      var btn = document.getElementById('downloadPng');
      if (!btn) return;
      btn.classList.remove('hidden');
      if (btn.getAttribute('data-ready')==='1') return;
      btn.setAttribute('data-ready','1');

      btn.addEventListener('click',function(ev){
        ev.preventDefault();
        var ids=['chartParticipants','chartPoints','chartRatio','chartGaps'];
        var canvases = ids.map(function(id){return document.getElementById(id);}).filter(Boolean);
        if (!canvases.length) return;

        var padding=40;
        var dpr=window.devicePixelRatio||1;
        var width=Math.max.apply(null,canvases.map(function(c){return c.width||c.clientWidth||0;}));
        var height=canvases.reduce(function(s,c){return s+(c.height||c.clientHeight||0);},0)+padding*(canvases.length-1);

        var out=document.createElement('canvas');
        out.width=Math.max(1,Math.round(width*dpr));
        out.height=Math.max(1,Math.round(height*dpr));
        var g=out.getContext('2d');
        g.scale(dpr,dpr);

        var bg=getComputedStyle(document.body).backgroundColor||'#000000';
        g.fillStyle=bg;
        g.fillRect(0,0,width,height);

        var y=0;
        canvases.forEach(function(c){
          var w=c.width||c.clientWidth||0;
          var h=c.height||c.clientHeight||0;
          g.drawImage(c,0,y,w,h);
          y+=h+padding;
        });

        try{
          var url=out.toDataURL('image/png');
          var a=document.createElement('a');
          a.href=url;
          a.download='raid-charts.png';
          document.body.appendChild(a);
          a.click();
          a.remove();
          setTimeout(function(){URL.revokeObjectURL(url);},1000);
        }catch(e){
          console.error(e);
          alert('Export failed. Try a different browser.');
        }
      });
    }

    function analyzeRaids(raidArray){
      // raidArray: [{date, points, participants}]
      var rows = raidArray.map(function(r){
        var d = new Date(r.date);
        var pts = parseNumberWithSuffix(String(r.points));
        var p = Number(r.participants);
        return { date:d, participants:p, points:pts };
      }).filter(function(r){
        return isFinite(r.points) && isFinite(r.participants) && !isNaN(r.date.getTime());
      }).sort(function(a,b){return a.date-b.date;});

      if (!rows.length){
        $('#summary').innerHTML =
          '<div class="card glass rounded-2xl p-4 md:p-6 col-span-full text-ink-300 text-sm">No valid raid rows found in raids.json.</div>';
        return;
      }

      for (var i=0;i<rows.length;i++){
        rows[i].ratio = rows[i].participants ? rows[i].points/rows[i].participants : 0;
        if (i===0) rows[i].gapDays = null;
        else {
          var diff = rows[i].date - rows[i-1].date;
          rows[i].gapDays = Math.round(diff/(1000*60*60*24));
        }
      }

      renderSummary(rows);

      var labels=rows.map(function(r){return r.date;});
      var participants=rows.map(function(r){return {x:r.date,y:r.participants};});
      var points=rows.map(function(r){return {x:r.date,y:r.points};});
      var ratio=rows.map(function(r){return {x:r.date,y:r.ratio};});
      var gaps=rows
        .map(function(r){return {x:r.date,y:(r.gapDays==null?null:r.gapDays)};})
        .filter(function(p){return p.y!=null;});

      destroyChartIfExists(ctx.participants);
      destroyChartIfExists(ctx.points);
      destroyChartIfExists(ctx.ratio);
      destroyChartIfExists(ctx.gaps);

      ctx.participants = makeLineChart('chartParticipants',labels,participants,'Participants',null);
      ctx.points        = makeLineChart('chartPoints',labels,points,'Points',formatCompact);
      ctx.ratio         = makeLineChart('chartRatio',labels,ratio,'Pts / Participant',formatCompact);
      ctx.gaps          = makeLineChart(
        'chartGaps',
        gaps.map(function(g){return g.x;}),
        gaps,
        'Days between raids',
        null
      );

      renderTable(rows);
      setupDownload();
    }

    async function loadRaids(){
      try{
        var res = await fetch('./data/raids.json');
        if (!res.ok) throw new Error('HTTP '+res.status);
        var json = await res.json();
        var raids = Array.isArray(json) ? json : json.raids;
        if (!raids || !raids.length) throw new Error('Empty raids array');
        analyzeRaids(raids);
      }catch(e){
        console.error(e);
        $('#summary').innerHTML =
          '<div class="card glass rounded-2xl p-4 md:p-6 col-span-full text-red-300 text-sm">Error loading raids.json: '+
          e.message+'</div>';
      }
    }

    // --- Internal nav (Raid Analysis / Helper) ---
    document.querySelectorAll("button[data-view]").forEach(btn => {
      btn.addEventListener("click", () => {
        const view = btn.dataset.view;

        document.querySelectorAll(".navbtn").forEach(b =>
          b.classList.toggle("active", b === btn)
        );

        document.querySelectorAll("section[id^='view-']").forEach(sec => {
          sec.classList.toggle("hidden", sec.id !== "view-" + view);
        });
      });
    });

    // --- Helper: paste → JSON ---
    function helperParseSuffix(val) {
      var cleaned = String(val).replace(/,/g,'').trim();
      var m = cleaned.match(/^([\d.]+)\s*([KMB]?)$/i);
      if (!m) return Number(cleaned) || 0;
      var num = parseFloat(m[1]);
      var suf = (m[2]||'').toUpperCase();
      var mult = suf==='B' ? 1e9 : suf==='M' ? 1e6 : suf==='K' ? 1e3 : 1;
      return num * mult;
    }

    function helperParse(raw) {
      var lines = raw.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      var rows = [];

      for (let line of lines) {
        let parts = line.split(/[\t ]+/).filter(Boolean);
        if (parts.length < 3) continue;

        let dateStr = parts[parts.length - 1];
        let participantsStr = parts[parts.length - 2];
        let pointsStr = parts[parts.length - 3];

        let date = new Date(dateStr);
        let participants = parseInt(participantsStr, 10);
        let points = helperParseSuffix(pointsStr);

        if (!isFinite(points) || !isFinite(participants) || isNaN(date.getTime())) continue;

        rows.push({
          date: date.toISOString().slice(0, 10),
          points: points,
          participants: participants
        });
      }

      return rows;
    }

    document.getElementById("helper-convert").addEventListener("click", () => {
      const raw = document.getElementById("helper-raw").value;
      const rows = helperParse(raw);
      const json = JSON.stringify({ raids: rows }, null, 2);
      document.getElementById("helper-out").textContent = json;
    });

    window.addEventListener('load', loadRaids);
  </script>
</body>
</html>
